apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keystone
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'https://tarballs.opendev.org/openstack/openstack-helm'
    chart: keystone
    targetRevision: 2024.2.4
    helm:
      parameters:
        # --- 1. FORCE JOB CREATION (Fixes "dependency not found") ---
        - name: manifests.job_db_init
          value: "true"
        - name: manifests.job_db_sync
          value: "true"
        - name: manifests.job_bootstrap
          value: "true"
        - name: manifests.job_credential_setup
          value: "true"
        - name: manifests.job_fernet_setup
          value: "true"

        # --- 2. CONNECTIONS ---
        - name: conf.keystone.database.connection
          value: mysql+pymysql://keystone:password@mariadb.openstack.svc.cluster.local/keystone
        - name: conf.keystone.oslo_messaging_rabbit.transport_url
          value: rabbit://openstack:password@rabbitmq.openstack.svc.cluster.local:5672/
        - name: conf.keystone.cache.backend
          value: dogpile.cache.memcached
        - name: conf.keystone.cache.memcache_servers
          value: memcached.openstack.svc.cluster.local:11211
        - name: conf.keystone.DEFAULT.admin_token
          value: password

        # --- 3. LAB RESOURCE TUNING (Prevents "Pending" state) ---
        - name: pod.replicas.api
          value: "1"
        - name: pod.resources.api.requests.memory
          value: "512Mi"
        - name: pod.resources.api.requests.cpu
          value: "100m"
        - name: pod.resources.api.limits.memory
          value: "1024Mi"
        - name: pod.resources.api.limits.cpu
          value: "1000m"
        # Reduce job resources too
        - name: pod.resources.jobs.bootstrap.requests.memory
          value: "128Mi"
        - name: pod.resources.jobs.bootstrap.requests.cpu
          value: "100m"

        # --- 4. BOOTSTRAP SCRIPT ---
        - name: bootstrap.enabled
          value: "true"
        - name: bootstrap.script
          value: |
            keystone-manage db_sync
            keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
            keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
            keystone-manage bootstrap --bootstrap-password password \
              --bootstrap-admin-url http://keystone-api.openstack.svc.cluster.local:5000/v3/ \
              --bootstrap-internal-url http://keystone-api.openstack.svc.cluster.local:5000/v3/ \
              --bootstrap-public-url http://keystone-api.openstack.svc.cluster.local:5000/v3/ \
              --bootstrap-region-id RegionOne
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: openstack
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
